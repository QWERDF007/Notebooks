# [Towards Total Recall in Industrial Anomaly Detection](https：//arxiv.org/abs/2106.08265)

## Abstract

能够发现有缺陷的部件是大规模工业制造中的关键。我们在这项工作中面临的一个特殊挑战是冷启动问题：仅使用正常(无缺陷)的示例图像来拟合模型。虽然针对每个类别手工设计解决方案是可能的，但目标是构建可以在许多不同任务上自动并且同时发挥良好作用的系统。表现最佳的方法将 ImageNet 模型的嵌入与一个异常检测模型相结合。在这篇文章中，我们在这条研究路线的基础上提出了 PatchCore，它使用了一个包含正常区块 (patch) 的特征的最大代表性内存库。PatchCore 在实现最先进的检测和定位性能的同时，提供了有竞争力的推理时间。在具有挑战性的、广泛使用的 MVTec AD 基准测试中，PatchCore 实现了高达 99.6% 的图像级异常检测AUROC 分数，与下一个最佳的竞争对手相比，将错误降低了一半以上。我们还在两个额外的数据集上报告了有竞争力的结果，并且发现在少样本的极端情况下也表现良好。代码： [github.com/amazon-research/patchcore-inspection](https：//github.com/amazon-science/patchcore-inspection)。

<img src="./assets/patchcore_fig1.png">

图 1：MVTec基准数据集的示例。图像上叠加了 PatchCore 的分割结果。橙色边界表示异常的实际分割图的异常轮廓，如破碎的玻璃、划痕、烧伤或蓝橙色渐变的结构变化。

> 算法流程：通过预训练好的 ResNet-50 在正常样本上面进行特征提取（不从 ResNet 最后一层获取特征，而是从中间蹭获取）随后再采用 coreset subsampling，进行有效的降采样生成更加核心的特征集即 memory bank 。 在测试的时候，将提取到的特征通过 nearest neighbour search（最近邻搜索）：每个 query 进来，首先找最近距离最近的领域质心，找到距离 query 最近的质心后，锁定该领域，然后在该领域内计算距离最远的数据点，用该距离计算异常分数 (anomaly score)，判断是否异常，得到结果。

## 1.  Introduction

能够在图像中检测到异常模式是人类认知中一个深深根植的特征。人类只需看几个正常的实例，就能区分数据中的期望方差和异常值。在这项工作中，我们解决了这个问题的计算版本，即工业图像数据的视觉检测的冷启动异常检测。在许多工业场景中，获取正常的示例的图像很容易，但获取完整的指定预期缺陷变化很费力且复杂。这个任务自然地被表述为一个分布外检测问题，其中模型需要区分样本是从训练数据分布中抽取的，还是在其支持集之外的。工业视觉缺陷分类尤其困难，因为错误可以从细微改变(如细微划痕)到更大的结构缺陷(如缺少组件)。MVTec AD基准中的一些示例以及我们提出方法的结果如图1所示。现有的冷启动工业视觉异常检测工作依赖于通过自动编码方法、GAN或其他无监督适应方法来学习正常的分布的模型。最近，[4， 10]提出利用来自 ImageNet 分类的普通深度表示，而不需要适应目标分布。尽管缺少适应，这些模型提供了强大的异常检测性能，甚至可以可靠地定位缺陷的空间位置。这些技术背后的关键原理是测试样本与正常的样本之间的特征匹配，同时利用深度特征表示的多尺度特性。细微的、细粒度的缺陷分割由高分辨率特征覆盖，而结构偏差和整个图像级异常检测则应该由更高抽象级别的特征来描述。这种非自适应方法的固有缺点是，在更高的抽象级别匹配置信度有限：来自 ImageNet 训练的高级抽象特征与工业环境所需的抽象特征重合性很小。此外，这些方法在测试时可以使用的正常的上下文实际上受提取的高级特征表示的数量限制。

在本文中，我们提出了 PatchCore 作为一个有效的解决方法:(1)最大化测试时可用的正常的信息，(2)减少对 ImageNet 类别的偏置，(3)保持高推理速度。PatchCore 利用这样一个事实: 只要一个块 (patch) 异常，图像就可以被分类为异常。PatchCore 通过利用局部聚合的中级特征块 (patch) 来实现这一点。使用中间层网络 patch 特征使 PatchCore 在高分辨率下运行时对 ImageNet 类别的偏差降到最低，而对局部邻域的特征聚合可以保留足够的空间上下文。这就形成了一个庞大的内存库，使得 PatchCore 可以在测试时最佳利用可用的正常的上下文。最后，为了实际应用性，PatchCore 还引入了**贪心核心集子采样**来减少提取的基于块 (patch) 的内存库中的冗余，显着降低存储器需求和推理时间，这使得 PatchCore 非常适合实际的工业使用案例。

在多样化的 MVTec AD 和专业的磁铁瓷砖缺陷 (MTD) 工业异常检测基准测试中进行的实验展示了 PatchCore 在工业异常检测中的强大功效。它在 MVTec AD 和MTD 上取得了最先进的图像级检测分数，在 MVTec AD上 近乎完美 (AUROC达到99.6%)，比先前方法的检测错误减少了一半以上，并取得了最先进的工业异常定位性能。PatchCore 在保留快速的推理时间的同时而无需在手头的数据集上训练。这使得 PatchCore 非常适合工业异常检测的实际应用。此外，进一步的实验展示了 PatchCore的 高样本效率，在仅使用正常训练数据的一小部分的情况下，其性能与现有的异常检测方法相当。

## 2. Related Works

大多数异常检测模型依赖于学习固有于正常数据的表示。例如，这可以通过使用自动编码器模型来实现[44]。为了更好地估计正常特征分布，已提出了基于高斯混合模型的扩展[60]、对抗生成目标训练[2，39，43]、对预定义物理增强的不变性[25]、重建隐特征的鲁棒性[29]、原型内存库[21]、注意力引导[52]、结构目标[7，59]或受限表示空间[38]等方法。其他无监督表示学习方法也可以类似地利用，如通过GAN[13]、学习预测预定义的几何变换[20]或通过归一化流[42]。给定各自的正常表示和新的测试表示，那么异常检测可以成为一个重建错误[44]、到k个最近邻居的距离[18]，或在这些特征之上微调单类分类模型（如 OC-SVMs [46]或 SVDD [50，56]）的简单问题。对于这些方法中的大多数，基于像素级重构误差的异常定位是自然而然的，也可以使用基于显著性的方法（如GradCAM [47]或 XRAI [28]）进行异常分割[42， 45， 52]。

**工业异常检测。**虽然关于通过学习正常表示进行常规异常检测的文献很多，但工业图像数据具有自己的挑战[5]，最近的研究从[4]开始，展示了使用在大型外部自然图像数据集（如ImageNet [16]）上预训练的模型而不需要对手头的数据进行任何适应性调整的最先进检测性能。这催生了其他依赖于更好地重用预训练特征的工业异常检测方法，例如SPADE [10]，它利用包含各种特征层次结构的内存库进行细粒度的、基于kNN [18]的异常分割和图像级异常检测。类似地，[14]最近提出了PaDiM，它利用局部约束的装袋特征 (bag-of-features) 方法[8]，估计区块级别 (patch-level) 的特征分布矩（均值和协方差）用于区块级别 (patch-level) 的马氏距离测量[33]。这种方法类似于[40]在完整图像上进行的研究。为了更好地考虑自然预训练和工业图像数据之间的分布偏移，可以进行后续适应，例如通过学生-教师知识蒸馏[24]（例如在[6，45]中）或在预训练网络特征之上训练的归一化流[17，30]。

PatchCore 中使用的具体组件与 SPADE 和 PaDiM 最相关。SPADE 利用预训练的骨干网络提取的正常特征的内存库，具有单独的方法进行图像级和像素级异常检测。PatchCore 同样使用内存库，但是具有关键的邻域感知的区块级别的特征，这对于实现更高的性能至关重要，因为保留了更多的正常上下文并且合适的归纳偏差被纳入。此外，内存库采用核心集子采样以确保在更高性能下降低推理成本。核心集通过找到最佳近似某个可用集合结构的子集，并允许使用显着降低的成本进行近似解决方案查找[1， 9]，在基本 kNN 和 kMeans 方法[22]或混合模型[19]中已经有了长期使用。更近期，基于核心集的方法也被引入到深度学习方法中，例如用于网络剪枝[34]、主动学习[48]以及增加小批量有效数据覆盖率以改进 GAN 训练[49]或表示学习[41]。后三者都成功地利用了贪婪核心集选择机制。由于我们目的是逼近内存库特征空间覆盖，我们类似地为 PatchCore 适应了贪婪核心集机制。最后，我们对图像级异常检测和异常分割的基于区块的方法与PaDiM 相关，目的是鼓励更高的异常检测敏感性。我们使用一个高效的区块特征内存库，该内存库在测试时可访问所有的区块，而 PaDiM 将区块级别的异常检测限制在每个区块特定的马氏距离度量。通过这种方式，PatchCore 不太依赖图像对齐，同时使用更大的正常上下文来估计异常。此外，与 PaDiM 不同，输入图像在训练和测试期间不需要相同的形状。最后，PatchCore 利用局部感知的区块特征分数来考虑局部空间方差，并减少对 ImageNet 类别的偏差。

## 3. Method

PatchCore 方法包括以下几个部分：局部区块 (patch) 特征聚合到内存库中（[§3.1](#3.1.-Locally-aware-patch-features)），核心集减少方法以提高效率（§3.2），最后是完整算法，用于检测和定位决策（§3.3）。

### 3.1. Locally aware patch features

我们使用XN表示训练时可用的所有正常图像集合(∀x ∈ XN : yx = 0),其中yx ∈ {0,1}表示图像x是否为标称(0)或异常(1)。相应地,我们定义XT为测试时提供的样本集合,其中∀x ∈ XT : yx ∈ {0,1}。遵循[4]、[10]和[14],PatchCore使用在ImageNet上预训练的网络φ。由于特定网络层级的特征起着重要作用,我们使用φi,j = φj(xi)表示数据集X中图像xi的第j层网络φ的特征。如果没有特别说明,与现有文献一致,j索引类似ResNet[23]的体系结构(如ResNet50或WideResnet-50[57])的特征图,其中j∈{1,2,3,4}表示各自空间分辨率块的最终输出。特征表示的一个选择是网络特征层次结构中的最后一层。这在[4]或[10]中完成,但引入了以下两个问题。首先,它会丢失更本地化的标称信息[14]。由于测试时遇到的异常类型事先不可知,这会损害后续的异常检测性能。其次,在ImageNet上预训练的网络中的非常深层和抽象的特征会偏向自然图像分类任务,与冷启动工业异常检测任务及手头评估的数据之间只有很小的重叠。















