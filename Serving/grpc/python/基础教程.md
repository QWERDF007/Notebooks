# 基础教程

python 中 gRPC 的基础介绍教程。

本教程为 python 程序员提供了使用 gRPC 的基础介绍。

通过学习本示例，你会学到：

- 在 `.proto` 文件中定义服务
- 使用 protocol buffer 编译器生成服务端和客户端代码
- 使用 python gRPC API 为你的服务写一个简单的客户端和服务端

本文假设你已经阅读了 [gRPC 介绍](../什么是gRPC.md#gRPC 介绍)，并且熟悉 [protocol buffers]()。你可以在 [proto3 语言指南]()和 [python 生成代码指南]()中找到跟多信息。

## 为什么使用 gRPC

示例是一个简单的路由映射应用程序，允许客户端获取路由上的特征信息，创建路由的摘要，并与服务器和其他客户端交换路由信息，比如流量更新。

使用 gRPC，可以在 `.proto` 文件中定义一次服务，并在任何 gRPC 支持的语言中生成服务端和客户端，可以在大型数据中心的服务器到你的平板电脑的各种环境中运行——所有不同语言之间的通信和环境的复杂性都由 gRPC 为你处理。还获得了 protocol buffer 的所有优势，包括高效的序列化、简单的接口定义语言 (IDL) 和便利的接口更新。

## 示例代码和设置

本教程的示例代码是  [grpc/grpc/examples/python/route_guide](https://github.com/grpc/grpc/tree/master/examples/python/route_guide)。要下载示例，通过以下指令克隆 gprc：

```shell
git clone https://github.com/grpc/grpc
```

然后进入到该仓库的 `examples/python/route_guide` 目录：

```shell
cd grpc/examples/python/route_guide
```

你应该已经安装了生成服务端和客户端接口代码的相关工具——如果还没安装，请按照[快速入门](./快速入门.md)中的安装说明进行安装。

## 定义服务

第一步 (正如你在 gRPC 介绍中了解的那样) 是使用 protocol buffers 定义服务和方法的 request 和 response 类型。你可以在 [examples/protos/route_guide.proto](https://github.com/grpc/grpc/blob/master/examples/protos/route_guide.proto) 中看到完整的 .proto 文件。

要定义一个服务，你要在你的 .proto 文件中指定一个命名为 `service` 的：

```protobuf
service RouteGuide {
   // (Method definitions not shown)
}
```

然后在服务定义中定义 `rpc` 方法，指定它们的请求和响应类型。gRPC 允许你定义四种服务方法，它们都在 `RouteGuide` 服务中使用：

- 一个简单的 RPC，其中客户端使用存根发送一个请求到服务器并等待响应，就像普通的函数调用一样。

  ```protobuf
  // Obtains the feature at a given position.
  rpc GetFeature(Point) returns (Feature) {}
  ```

- 一个响应流 RPC，其中客户端向服务器发送请求，并得到一个流来读取返回的消息序列。客户端从返回的流中读取，直到没有更多的消息。正如你在示例中看到的，通过在响应类型之前放置 `stream` 关键字来指定一个响应流方法。

  ```protobuf
  // Obtains the Features available within the given Rectangle.  Results are
  // streamed rather than returned at once (e.g. in a response message with a
  // repeated field), as the rectangle may cover a large area and contain a
  // huge number of features.
  rpc ListFeatures(Rectangle) returns (stream Feature) {}
  ```

- 一个请求流 RPC，其中客户端写入消息序列，并再一次使用提供流将它们发送给服务器。一旦客户端完成写入消息，它将等待服务器读取所有消息并返回它们的响应。通过在请求类型之前放置 `stream` 关键字来指定一个请求流方法。

  ```protobuf
  // Accepts a stream of Points on a route being traversed, returning a
  // RouteSummary when traversal is completed.
  rpc RecordRoute(stream Point) returns (RouteSummary) {}
  ```

- 双向流 RPC，其中双方使用一个读写流发送消息序列。两个流独立运作，因此客户端和服务端可以以任意顺序读取：例如，服务端可以在写响应之前等待接收完全部客户端消息，或者交替读取消息然后写消息，或者其他的读写组合。每个流中的消息的顺序被保留。通过在请求和响应之前放置 `stream` 关键字可以指定这类方法。

  ```protobuf
  // Accepts a stream of RouteNotes sent while a route is being traversed,
  // while receiving other RouteNotes (e.g. from other users).
  rpc RouteChat(stream RouteNote) returns (stream RouteNote) {}
  ```

你的 `.proto` 文件也包含了用于服务接口中使用的所有请求和响应类型的 protocol buffer 消息类型定义——例如，下面是 `Point` 消息类型：

```protobuf
// 在 E7 表示中点被表示为纬度-经度对
// 度乘以 10**7，四舍五入到最接近的整数
// 维度应该在 [-90,90] 之间，经度应该在 [-180,180] 之间
message Point {
  int32 latitude = 1;
  int32 longitude = 2;
}
```

## 生成客户端和服务端代码

接下来，你需要从你的 .proto 服务定义生成 gRPC 客户端和服务端接口。

首先，安装 `grpcio-tools` 包：

```shell
pip install grpcio-tools
```

使用下面的命令生成 python 代码：

```shell
python -m grpc_tools.protoc -I../../protos --python_out=. --grpc_python_out=. ../../protos/route_guide.proto
```

注意，因为已经在示例目录中提供了一份生成的代码，运行该命令会重新生成相应的文件而不是创建一个新文件。生成的代码文件叫做 `route_guide_pb2.py` 和 `route_guide_pb2_grpc.py` 且包含：

- route_guide.proto 中定义的消息类
- route_guide.proto 中定义服务类
  - `RouteGuideStub`，客户端用它来调用 RouteGuide RPCs
  - `RouteGuideServicer`，它定义了 RouteGuide 服务实现的接口
- route_guide.proto 中定义的服务函数
  - `add_RouteGuideServicer_to_server`，添加一个 `RouteGuideServicer` 到 `grpc.Server` 

## 创建服务端

首先看看如何创建一个 `RouteGuide` 服务端。如果你只对创建 gRPC 客户端感兴趣，可以跳过这一节，直接进入到[创建客户端]()。

创建并运行 `RouteGuide` 服务端分为两个工作项：

- 实现从服务定义生成的服务器接口的执行实际服务器工作的函数。
- 运行 gRPC 服务器来监听客户端请求和传输响应。

你能在 [examples/python/route_guide/route_guide_server.py](https://github.com/grpc/grpc/blob/master/examples/python/route_guide/route_guide_server.py) 中找到 `RouteGuide` 服务端示例。